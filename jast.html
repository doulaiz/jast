<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>JAST</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #fff;
        text-align: center;
        margin: 0;
        padding: 0;
        color: #202124;
      }
      header {
        position: fixed;
        top: 0;
        width: 100%;
        background-color: #fff;
        border-bottom: 1px solid #dadce0;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        z-index: 1000;
      }
      .menuBtn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 24px;
        color: #5f6368;
      }
      .menuBtn:hover {
        color: #202124;
      }
      h1 {
        font-size: 60px;
        font-weight: 400;
        margin-top: 100px;
        margin-bottom: 40px;
        letter-spacing: 2px;
        color: #4285f4;
      }
      .jast-title {
        font-family: "Product Sans", Arial, sans-serif;
        font-size: 60px;
        font-weight: 500;
        margin-top: 100px;
        margin-bottom: 40px;
        font-weight: 700;
        letter-spacing: 1px;
      }
      .jast-title .g1 {
        color: #4285f4;
      } /* Blue */
      .jast-title .g2 {
        color: #ea4335;
      } /* Red */
      .jast-title .g3 {
        color: #fbbc05;
      } /* Yellow */
      .jast-title .g4 {
        color: #34a853;
      } /* Green */
      .search-box {
        display: inline-block;
        padding: 8px 14px;
        border: 1px solid #dfe1e5;
        border-radius: 24px;
        font-size: 16px;
        width: 400px;
        outline: none;
        transition: box-shadow 0.2s;
      }
      .search-box:focus {
        box-shadow: 0 1px 6px rgba(32, 33, 36, 0.28);
        border-color: rgba(223, 225, 229, 0);
      }
      .btn {
        background-color: #f8f9fa;
        border: 1px solid #f8f9fa;
        border-radius: 4px;
        padding: 8px 16px;
        margin: 8px;
        font-size: 14px;
        color: #3c4043;
        cursor: pointer;
      }
      .btn:hover {
        border: 1px solid #dadce0;
        box-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
      }
      select,
      input[type="file"] {
        margin: 5px;
        padding: 6px;
        font-size: 14px;
      }
      table {
        margin: 30px auto;
        border-collapse: collapse;
        width: 95%;
        font-size: 14px;
      }
      th,
      td {
        border: 1px solid #dadce0;
        padding: 8px;
        text-align: left;
        vertical-align: top;
      }
      th {
        background-color: #f1f3f4;
      }
      /* Spinner styles */
      .spinner-container {
        margin-top: 20px;
        display: none;
        flex-direction: column;
        align-items: center;
      }
      .spinner {
        border: 6px solid #f3f3f3;
        border-top: 6px solid #4285f4;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .progress-text {
        margin-top: 10px;
        font-size: 14px;
        color: #5f6368;
      }
      /* Progress bar styles */
      .progress-bar {
        margin-top: 8px;
        width: 200px;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        background-color: #4285f4;
        width: 0%;
        transition: width 0.3s ease;
      }
      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.4);
      }
      .modal-content {
        background-color: #fff;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #dadce0;
        width: 300px;
        border-radius: 8px;
        text-align: left;
      }
      .modal-content h2 {
        margin-top: 0;
        font-size: 18px;
        color: #202124;
      }
      .modal-content label {
        display: block;
        margin-top: 10px;
        font-size: 14px;
      }
      .modal-content input {
        width: 100%;
        padding: 6px;
        margin-top: 4px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 14px;
      }
      .modal-content button {
        margin-top: 15px;
        padding: 8px 14px;
      }
      .errorBox {
        display: none;
        margin: 20px auto;
        max-width: 600px;
        background: #fdecea;
        color: #b71c1c;
        border: 1px solid #f5c6cb;
        border-radius: 6px;
        padding: 14px;
        font-size: 15px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <header>
      <button id="infoBtn" class="menuBtn" title="Information">?</button>
      <button id="settingsBtn" class="menuBtn" title="Settings">âš™</button>
    </header>

    <h1 class="jast-title" title="Just Another Search Tool">
      <span class="g1">J</span>
      <span class="g2">A</span>
      <span class="g3">S</span>
      <span class="g4">T</span>
    </h1>
    <form>
      <input
        type="text"
        id="searchQuery"
        class="search-box"
        placeholder="Search..."
        autocomplete="on"
      /><br /><br />

      <input
        type="file"
        id="excelFile"
        accept=".xlsx, .xls"
        title="Select Excel file"
        class="btn"
        style="width: auto"
      />
      <select
        id="sheetSelect"
        style="display: none"
        title="Choose which sheet from your Excel file to use."
      ></select>
      <select
        id="columnSelect"
        style="display: none"
        title="Choose which column from your Excel file to use."
      ></select
      ><br />
      <script>
        // Clear file input on page reload
        document.addEventListener("DOMContentLoaded", function () {
          document.getElementById("excelFile").value = "";
        });

        // Show/hide sheet/column selects based on Excel file loaded
        const sheetSelect = document.getElementById("sheetSelect");
        const columnSelect = document.getElementById("columnSelect");
        document
          .getElementById("excelFile")
          .addEventListener("change", function () {
            if (this.files.length) {
              sheetSelect.style.display = "";
              columnSelect.style.display = "";
            } else {
              sheetSelect.style.display = "none";
              columnSelect.style.display = "none";
            }
          });
      </script>

      <button id="searchBtn" class="btn" type="submit">Search</button>
      <button id="exportBtn" class="btn" style="display: none">
        Export to Excel
      </button>
    </form>
    <!-- Spinner + Progress -->
    <div class="spinner-container" id="spinnerContainer">
      <div class="spinner"></div>
      <div class="progress-text" id="progressText">0 / 0</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>

    <table id="resultsTable" style="display: none">
      <thead>
        <tr id="resultsHeader">
          <th>URL Used</th>
          <th># of Results</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <h2>Settings</h2>
        <label for="apiKeyInput">Google API Key</label>
        <input type="text" id="apiKeyInput" />

        <label for="cxInput">Custom Search Engine ID</label>
        <input type="text" id="cxInput" />

        <label for="snippetCountInput">Number of Snippets</label>
        <input type="number" id="snippetCountInput" min="1" max="10" />

        <div style="display: flex; justify-content: flex-end">
          <button class="btn" id="saveSettingsBtn">Save</button>
        </div>
      </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
      <div class="modal-content">
        <h2>About JAST</h2>
        <p>
          JAST (Just Another Search Tool) lets you search Google Custom Search
          for results from a list of URLs loaded from Excel. Configure your API
          key and CSE ID in Settings. Import an Excel file, select the sheet and
          column with URLs, enter a search term, and view results.
        </p>
        <div style="display: flex; justify-content: flex-end">
          <button class="btn" id="closeInfoBtn">Close</button>
        </div>
      </div>
    </div>
    <script>
      const infoBtn = document.getElementById("infoBtn");
      const infoModal = document.getElementById("infoModal");
      const closeInfoBtn = document.getElementById("closeInfoBtn");
      infoBtn.onclick = () => {
        infoModal.style.display = "block";
      };
      closeInfoBtn.onclick = () => {
        infoModal.style.display = "none";
      };
      window.addEventListener("click", function (event) {
        if (event.target == infoModal) infoModal.style.display = "none";
      });

      // ESC key closes modals
      window.addEventListener("keydown", function (event) {
        if (event.key === "Escape") {
          document.getElementById("settingsModal").style.display = "none";
          document.getElementById("infoModal").style.display = "none";
        }
      });

      let workbook;
      let urls = [];

      // Load saved settings
      let apiKey = localStorage.getItem("googleApiKey") || "";
      let cx = localStorage.getItem("googleCx") || "";
      let snippetCount = parseInt(
        localStorage.getItem("snippetCount") || "5",
        10
      );

      // Settings modal logic
      const modal = document.getElementById("settingsModal");
      const settingsBtn = document.getElementById("settingsBtn");
      const saveSettingsBtn = document.getElementById("saveSettingsBtn");

      settingsBtn.onclick = () => {
        document.getElementById("apiKeyInput").value = apiKey;
        document.getElementById("cxInput").value = cx;
        document.getElementById("snippetCountInput").value = snippetCount;
        modal.style.display = "block";
      };

      saveSettingsBtn.onclick = () => {
        apiKey = document.getElementById("apiKeyInput").value.trim();
        cx = document.getElementById("cxInput").value.trim();
        snippetCount =
          parseInt(
            document.getElementById("snippetCountInput").value.trim(),
            10
          ) || 5;

        localStorage.setItem("googleApiKey", apiKey);
        localStorage.setItem("googleCx", cx);
        localStorage.setItem("snippetCount", snippetCount);

        modal.style.display = "none";
      };

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      };

      document.getElementById("excelFile").onchange = function () {
        const fileInput = document.getElementById("excelFile");
        if (!fileInput.files.length) {
          alert("Please select an Excel file first.");
          return;
        }
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = new Uint8Array(e.target.result);
          workbook = XLSX.read(data, { type: "array" });
          const sheetSelect = document.getElementById("sheetSelect");
          sheetSelect.innerHTML = "";
          workbook.SheetNames.forEach((name) => {
            const opt = document.createElement("option");
            opt.value = name;
            opt.textContent = name;
            sheetSelect.appendChild(opt);
          });
          loadColumns();
        };
        reader.readAsArrayBuffer(fileInput.files[0]);
      };

      document.getElementById("sheetSelect").onchange = loadColumns;

      function loadColumns() {
        const sheetName = document.getElementById("sheetSelect").value;
        if (!sheetName) return;
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        const firstRow = json[0];
        const colSelect = document.getElementById("columnSelect");
        colSelect.innerHTML = "";
        firstRow.forEach((colName, idx) => {
          const opt = document.createElement("option");
          opt.value = idx;
          opt.textContent = colName || `Column ${idx + 1}`;
          colSelect.appendChild(opt);
        });
        extractUrls();
      }

      document.getElementById("columnSelect").onchange = extractUrls;

      function extractUrls() {
        const sheetName = document.getElementById("sheetSelect").value;
        const colIndex = parseInt(
          document.getElementById("columnSelect").value
        );
        const sheet = workbook.Sheets[sheetName];
        const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        // Helper to extract FQDN from a URL
        function getFQDN(url) {
          try {
            let hostname = new URL(url).hostname;
            return hostname.replace(/^www\./, "");
          } catch {
            return url;
          }
        }

        urls = json
          .slice(1)
          .map((row) => row[colIndex])
          .filter((u) => !!u)
          .map(getFQDN);
        console.log("Extracted URLs:", urls);

        // Create table with only the first column (URLs)
        const table = document.getElementById("resultsTable");
        const tbody = table.querySelector("tbody");
        const theadRow = document.getElementById("resultsHeader");
        theadRow.innerHTML = `<th>URL Used</th>`;
        tbody.innerHTML = "";
        urls.forEach((url) => {
          const row = document.createElement("tr");
          row.innerHTML = `<td>${url}</td>`;
          tbody.appendChild(row);
        });
        table.style.display = "table";
      }

      document.getElementById("searchBtn").onclick = async function (event) {
        event.preventDefault();
        const query = document.getElementById("searchQuery").value.trim();
        if (!query) {
          alert("Please enter a search term.");
          return;
        }
        if (!urls.length) {
          alert("No URLs loaded from Excel.");
          return;
        }
        if (!apiKey || !cx) {
          alert(
            "Please set your API Key and Custom Search Engine ID in Settings."
          );
          return;
        }

        const table = document.getElementById("resultsTable");
        const tbody = table.querySelector("tbody");
        const theadRow = document.getElementById("resultsHeader");

        // Build header dynamically
        theadRow.innerHTML = `<th>URL Used</th><th># of Results</th>`;
        for (let i = 1; i <= snippetCount; i++) {
          theadRow.innerHTML += `<th> </th>`;
        }

        tbody.innerHTML = "";
        table.style.display = "table";

        const spinnerContainer = document.getElementById("spinnerContainer");
        const progressText = document.getElementById("progressText");
        const progressFill = document.getElementById("progressFill");
        spinnerContainer.style.display = "flex";
        progressText.textContent = `0 / ${urls.length}`;
        progressFill.style.width = "0%";

        let completed = 0;

        // Helper to bold search matches
        function boldMatches(text, query) {
          if (!text || !query) return text;
          // Escape regex special chars in query
          const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
          const regex = new RegExp(escaped, "gi");
          return text.replace(regex, (match) => `<b>${match}</b>`);
        }

        for (const url of urls) {
          // Rate limit: max 100 requests per minute (1 request every 600ms)
          const searchUrl = `https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(
            query + "+"
          )}&siteSearch:${encodeURIComponent(url)}`;

          await new Promise((resolve) => setTimeout(resolve, 600));

          try {
            const res = await fetch(searchUrl);
            if (res.status === 429) {
              showError(
                "Google says: Too many requests (error 429). Please check your API billing or try again later."
              );
              throw new Error("Rate limit exceeded");
            }
            const data = await res.json();

            const numResults = data.searchInformation?.totalResults || 0;
            const snippets = data.items
              ? data.items.slice(0, snippetCount).map((i) => i.snippet)
              : [];

            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${boldMatches(url, query)}</td>
            <td>${numResults}</td>
            ${Array.from(
              { length: snippetCount },
              (_, i) => `<td>${boldMatches(snippets[i] || "", query)}</td>`
            ).join("")}
          `;
            tbody.appendChild(row);
          } catch (err) {
            console.error("Error fetching for URL:", url, err);
            const row = document.createElement("tr");
            row.innerHTML = `<td>${url}</td><td colspan="${
              snippetCount + 1
            }">Error fetching results</td>`;
            tbody.appendChild(row);
          }
          completed++;
          progressText.textContent = `${completed} / ${urls.length}`;
          progressFill.style.width = `${(completed / urls.length) * 100}%`;
        }

        spinnerContainer.style.display = "none";
        document.getElementById("exportBtn").style.display = "inline-block";
      };

      // Export table to Excel
      document.getElementById("exportBtn").onclick = function () {
        event.preventDefault();
        const table = document.getElementById("resultsTable");
        const ws = XLSX.utils.table_to_sheet(table);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Results");
        XLSX.writeFile(wb, "jast_results.xlsx");
      };
    </script>

    <div id="errorBox" class="errorBox"></div>
    <script>
      function showError(message) {
        const errorBox = document.getElementById("errorBox");
        errorBox.textContent = message;
        errorBox.style.display = "block";
        setTimeout(() => {
          errorBox.style.display = "none";
        }, 6000);
      }
    </script>
  </body>
</html>
